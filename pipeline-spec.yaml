load_marc_data:
  pipeline:
  - run: load_marc_data
  - run: dump.to_path
    parameters:
      out-path: data/load_marc_data


get_ccl_queries_from_lc_topics:
  pipeline:
  - run: add_resource
    parameters:
      name: topics
      url: data/topics.xlsx
      format: xlsx
      sheet: "LC"
  - run: stream_remote_resources
  - run: topics_to_ccl_queries
  - run: dump.to_path
    parameters:
      out-path: data/ccl_queries
      resources: .*


search:
  pipeline:
  - run: load_resource
    parameters:
      url: data/search_results/datapackage.json
      resource: unique_records
  - run: load_resource
    parameters:
      url: data/search_results/datapackage.json
      resource: query_stats
  - run: load_resource
    parameters:
      url: data/ccl_queries/datapackage.json
      resource: ccl_queries
  - run: search
  - run: dump.to_path
    parameters:
      out-path: data/search_results


search_export:
  pipeline:
  - run: load_resource
    parameters:
      url: data/search_results/datapackage.json
      resource: unique_records
#      limit-rows: 500
  - run: search_filter
    parameters:
      min_year: 2005
  - run: search_marc_extract
    parameters:
      fields:
      - name: item_type_999
        marc_tag: "999"
        first_subfield_only: true
      - name: item_type_964
        marc_tag: "964"
        first_subfield_only: true
      - name: item_type_leader
        marc_leader_position: 6
        marc_leader_map:
          a: Language material
          c: Notated music
          d: Manuscript notated music
          e: Cartographic material
          f: Manuscript cartographic material
          g: Projected medium
          i: Nonmusical sound recording
          j: Musical sound recording
          k: Two-dimensional nonprojectable graphic
          m: Computer file
          o: Kit
          p: Mixed materials
          r: Three-dimensional artifact or naturally occurring object
          t: Manuscript language material
      - name: bibliographic_level
        marc_leader_position: 7
        marc_leader_map:
          a: Monographic component part
          b: Serial component part
          c: Collection
          d: Subunit
          i: Integrating resource
          m: Monograph/Item
          s: Serial
      - name: marc_856
        marc_tag: "856"
  - run: search_export
    parameters:
      export_keys:
      - title
      - pubyear
      - publisher
#      - uniformtitle
      - author
#      - isbn
      - language_code
      - custom_metadata
      - publication_distribution_details
#      - physical_description
      - notes
      - tags
      - url
      - migdar_id
#      - item_type_999
#      - item_type_964
#      - item_type_leader
#      - bibliographic_level
      - item_type
      - first_ccl_query
      - json
      - marc_856
  - run: sort
    parameters:
      resources: search_export
      sort-by: "{first_ccl_query}"
#  - run: search_export_to_zotero
#    parameters:
#      resource: search_export
#      out-path: data/search_export
  - run: set_types
    parameters:
      types:
        json: null
  - run: dump.to_path
    parameters:
      out-path: data/search_export
